<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markiva Docs - Off-Canvas Sidebar (Tab Disappears on Open)</title>

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />
  <!-- Animate.css (optional) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"
  />
  <!-- Your custom dark theme styles -->
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    /************************************************************
     * GLOBAL / LAYOUT
     ************************************************************/
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #0d1117;
      color: #c9d1d9;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Ubuntu, sans-serif;
      overflow: hidden; /* We'll allow scrolling in .docs-main and .docs-sidebar */
    }
    a {
      color: #58a6ff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* Fixed top navbar container */
    #navbarContainer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 999; /* ensures navbar is on top */
    }
    /* Reading progress bar also at top */
    #readingProgressBar {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      width: 0%;
      z-index: 1000;
      transition: width 0.2s;
    }

    /************************************************************
     * MAIN CONTAINER: below navbar, filling the rest
     ************************************************************/
    .docs-container {
      position: absolute;
      top: 56px; /* below the navbar height of 56px */
      left: 0;
      right: 0;
      bottom: 0;
      display: grid;
      grid-template-columns: 280px minmax(0,1fr) 240px; /* left, center, right */
      gap: 0;
      overflow: hidden; /* hide overflow outside .docs-main and .docs-sidebar */
    }

    /************************************************************
     * SIDEBAR: Desktop & Mobile
     ************************************************************/
    .docs-sidebar {
      background-color: #161b22;
      border-right: 1px solid #30363d;
      padding: 1rem 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative; /* for the close button, etc. */
      z-index: 900; /* below navbar(999), but above main content */
      overflow-y: auto; /* sidebar itself can scroll */
      transition: left 0.3s ease; /* for mobile off-canvas */
    }
    /* On mobile, shift sidebar left:-280px by default. Then .open => left:0. */
    @media (max-width: 992px) {
      .docs-sidebar {
        position: fixed;
        top: 56px;  /* so it sits below the navbar */
        bottom: 0;
        left: -280px; /* hidden off-canvas by default */
        width: 280px;
      }
      .docs-sidebar.open {
        left: 0;
      }
    }

    /* A small margin to push .sidebar-top content below the close button */
    .sidebar-top {
      margin-top: 2.5rem; /* adds space so the X isn't overlapping content */
    }

    /* Collapsible sections */
    .sidebar-section {
      margin-bottom: 0.5rem;
    }
    .sidebar-section-title {
      font-size: 0.85rem;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0;
    }
    .toggle-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0.4rem 1rem;
      color: #c9d1d9;
      background-color: transparent;
      border: none;
      width: 100%;
      text-align: left;
    }
    .toggle-btn:hover {
      background-color: #21262d;
    }
    .toggle-btn:focus {
      outline: none;
    }
    .toggle-icon {
      font-size: 0.85rem;
      color: #8b949e;
    }
    .sidebar-links {
      padding: 0 0.5rem;
    }
    .sidebar-link {
      display: block;
      padding: 0.4rem 1rem;
      color: #c9d1d9;
      border-left: 3px solid transparent;
    }
    .sidebar-link:hover {
      background-color: #21262d;
      color: #f0f6fc;
    }
    .sidebar-link.active {
      background-color: #21262d;
      border-left: 3px solid #58a6ff;
      color: #f0f6fc;
    }

    /* SEARCH BAR at bottom of sidebar */
    .sidebar-search-container {
      padding: 0.5rem 1rem;
      border-top: 1px solid #30363d;
    }
    .sidebar-search-container input {
      background-color: #0d1117;
      color: #c9d1d9;
      border: 1px solid #30363d;
    }
    .sidebar-search-container input::placeholder {
      color: #8b949e;
    }

    /* Close button (X) at top-right inside sidebar on mobile */
    .close-sidebar-btn {
      display: none; /* hidden on desktop */
    }
    @media (max-width: 992px) {
      .close-sidebar-btn {
        display: block;
        position: absolute;
        top: 0.50rem;
        right: 0.25rem;
        background: transparent;
        border: none;
        color: #c9d1d9;
        font-size: 1.25rem;
        cursor: pointer;
        z-index: 1001; /* above the sidebar contents */
      }
      .close-sidebar-btn:hover {
        color: #f0f6fc;
      }
    }

    /************************************************************
     * SEMI-CIRCLE TAB (on mobile) for opening the sidebar
     ************************************************************/
    .mobile-sidebar-tab {
      display: none; /* hidden on desktop */
    }
    @media (max-width: 992px) {
      .mobile-sidebar-tab {
        position: fixed;
        top: 70px; /* 70px from top of screen */
        left: 0;   /* pinned at the left edge */
        width: 40px;
        height: 80px;
        background-color: rgba(22, 27, 34, 0.8);
        border: 1px solid #30363d;
        border-top-right-radius: 40px;    
        border-bottom-right-radius: 40px;
        z-index: 995; /* above main content but below navbar(999) */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.6);
      }
      .mobile-sidebar-tab i {
        color: #c9d1d9;
        font-size: 1.25rem;
      }
      .mobile-sidebar-tab:hover {
        background-color: rgba(33, 38, 45, 0.8);
      }
    }

    /************************************************************
     * MAIN CONTENT
     ************************************************************/
    .docs-main {
      overflow-y: auto;
      background-color: #0d1117;
      padding: 2rem 1.5rem;
    }
    .docs-main h1, .docs-main h2, .docs-main h3, .docs-main h4 {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
      scroll-margin-top: 80px; /* offset for fixed navbar */
    }
    .docs-main p {
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    .docs-main pre code {
      display: block;
      background-color: #161b22;
      padding: 1rem;
      border-radius: 6px;
      color: #f0f6fc;
      overflow-x: auto;
    }
    .docs-main img {
      max-width: 100%;
      height: auto;
      margin: 1rem 0;
      display: block;
    }
    .docs-main p[align="center"] {
      text-align: center !important;
    }
    .docs-main p[align="center"] img {
      margin-left: auto;
      margin-right: auto;
    }

    /************************************************************
     * RIGHT SIDEBAR (TOC)
     ************************************************************/
    .docs-toc {
      background-color: #161b22;
      border-left: 1px solid #30363d;
      overflow-y: auto;
      padding: 1rem;
    }
    .docs-toc h6 {
      text-transform: uppercase;
      font-size: 0.75rem;
      color: #8b949e;
      margin-bottom: 0.75rem;
      letter-spacing: 0.05em;
    }
    .toc-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .toc-list li {
      margin-bottom: 0.5rem;
    }
    .toc-link {
      color: #c9d1d9;
      font-size: 0.9rem;
      text-decoration: none;
    }
    .toc-link:hover {
      color: #f0f6fc;
      text-decoration: underline;
    }
    .toc-link.toc-active {
      color: #3ee55a;
      font-weight: 600;
    }

    /************************************************************
     * TABLE / BLOCKQUOTE / HR for better markdown appearance
     ************************************************************/
    .docs-main table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      background-color: #161b22;
      border: 1px solid #30363d;
      border-radius: 4px;
    }
    .docs-main table thead tr {
      background-color: #21262d;
    }
    .docs-main table th,
    .docs-main table td {
      padding: 0.75rem 1rem;
      border: 1px solid #30363d;
      vertical-align: middle;
    }
    .docs-main table tbody tr:nth-child(even) {
      background-color: #1b1f23;
    }
    .docs-main table tbody tr:hover {
      background-color: #24292e;
    }
    .docs-main blockquote {
      margin: 1rem 0;
      padding: 1rem 1.5rem;
      border-left: 4px solid #3ee55a;
      background-color: #161b22;
      color: #b1bac4;
      border-radius: 4px;
    }
    .docs-main blockquote p {
      margin-bottom: 0;
    }
    .docs-main ul,
    .docs-main ol {
      margin-left: 1.5rem;
      margin-bottom: 1.25rem;
    }
    .docs-main li {
      margin-bottom: 0.5rem;
    }
    .docs-main hr {
      border-color: #30363d;
      margin: 2rem 0;
    }

    /************************************************************
     * RESPONSIVE: Hide sidebars on narrower screens
     ************************************************************/
    @media (max-width: 992px) {
      .docs-container {
        grid-template-columns: 1fr; /* only center content in main view */
      }
      .docs-toc {
        display: none; /* hide right sidebar on mobile */
      }
    }
  </style>
</head>
<body>
  <!-- FIXED NAVBAR -->
  <div id="navbarContainer"></div>

  <!-- READING PROGRESS BAR -->
  <div id="readingProgressBar" class="bg-success"></div>

  <!-- Main Container below navbar -->
  <div class="docs-container">
    <!-- LEFT SIDEBAR (Desktop) / OFF-CANVAS (Mobile) -->
    <nav class="docs-sidebar" id="docsSidebar">
      <!-- Close button (mobile) -->
      <button class="close-sidebar-btn" id="closeSidebarBtn" aria-label="Close sidebar">
        <i class="bi bi-x"></i>
      </button>

      <div class="sidebar-top">
        <!-- Category: Welcome -->
        <div class="sidebar-section">
          <button
            class="toggle-btn"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#catWelcomeLinks"
            aria-expanded="true"
            aria-controls="catWelcomeLinks"
          >
            <span class="sidebar-section-title">Welcome</span>
            <i class="bi bi-chevron-down toggle-icon"></i>
          </button>
          <div class="collapse show" id="catWelcomeLinks">
            <div class="sidebar-links">
              <a
                href="#"
                class="sidebar-link doc-link"
                data-doc="welcome.md"
                id="welcomeLink"
              >
                Intro to Markiva
              </a>
            </div>
          </div>
        </div>

        <!-- Category 1: Start Here -->
        <div class="sidebar-section">
          <button
            class="toggle-btn"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#catOneLinks"
            aria-expanded="true"
            aria-controls="catOneLinks"
          >
            <span class="sidebar-section-title">Start Here</span>
            <i class="bi bi-chevron-down toggle-icon"></i>
          </button>
          <div class="collapse show" id="catOneLinks">
            <div class="sidebar-links">
              <a href="#" class="sidebar-link doc-link" data-doc="getting-started.md">
                Getting Started
              </a>
              <a href="#" class="sidebar-link doc-link" data-doc="manual-setup.md">
                Manual Setup
              </a>
              <a href="#" class="sidebar-link doc-link" data-doc="env-impact.md">
                Environmental Impact
              </a>
            </div>
          </div>
        </div>

        <!-- Category 2: Guides -->
        <div class="sidebar-section">
          <button
            class="toggle-btn"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#catTwoLinks"
            aria-expanded="true"
            aria-controls="catTwoLinks"
          >
            <span class="sidebar-section-title">Guides</span>
            <i class="bi bi-chevron-down toggle-icon"></i>
          </button>
          <div class="collapse show" id="catTwoLinks">
            <div class="sidebar-links">
              <a href="#" class="sidebar-link doc-link" data-doc="authoring-content.md">
                Authoring Content
              </a>
              <a href="#" class="sidebar-link doc-link" data-doc="css-styling.md">
                CSS &amp; Styling
              </a>
              <a href="#" class="sidebar-link doc-link" data-doc="customizing.md">
                Customizing
              </a>
            </div>
          </div>
        </div>

        <!-- Category 3: Components -->
        <div class="sidebar-section">
          <button
            class="toggle-btn"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#catThreeLinks"
            aria-expanded="true"
            aria-controls="catThreeLinks"
          >
            <span class="sidebar-section-title">Components</span>
            <i class="bi bi-chevron-down toggle-icon"></i>
          </button>
          <div class="collapse show" id="catThreeLinks">
            <div class="sidebar-links">
              <a href="#" class="sidebar-link doc-link" data-doc="cards.md">Cards</a>
              <a href="#" class="sidebar-link doc-link" data-doc="code.md">Code</a>
              <a href="#" class="sidebar-link doc-link" data-doc="file-tree.md">File Tree</a>
            </div>
          </div>
        </div>

        <!-- Category 4: Reference -->
        <div class="sidebar-section">
          <button
            class="toggle-btn"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#catFourLinks"
            aria-expanded="true"
            aria-controls="catFourLinks"
          >
            <span class="sidebar-section-title">Reference</span>
            <i class="bi bi-chevron-down toggle-icon"></i>
          </button>
          <div class="collapse show" id="catFourLinks">
            <div class="sidebar-links">
              <a href="#" class="sidebar-link doc-link" data-doc="api-reference.md">
                API Reference
              </a>
              <a href="#" class="sidebar-link doc-link" data-doc="cli.md">
                CLI Usage
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- SEARCH BAR at the bottom -->
      <div class="sidebar-search-container">
        <input
          type="text"
          id="docSearch"
          class="form-control"
          placeholder="Search docs..."
          oninput="filterDocLinks()"
        />
      </div>
    </nav>

    <!-- CENTER DOC AREA -->
    <main class="docs-main" id="docsContent">
      <!-- We'll auto-load welcome.md, so no default text here. -->
    </main>

    <!-- RIGHT SIDEBAR (TOC) -->
    <aside class="docs-toc">
      <h6>On This Page</h6>
      <ul class="toc-list" id="tocList">
        <li class="text-secondary" style="font-size: 0.85rem;">No headings yet.</li>
      </ul>
    </aside>
  </div>

  <!-- SEMI-CIRCLE TAB: show on mobile for opening the sidebar -->
  <div class="mobile-sidebar-tab d-lg-none" id="sidebarTab">
    <i class="bi bi-list"></i>
  </div>

  <!-- JS Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Partial loader (navbar only) -->
  <script src="js/includePartials.js"></script>
  <!-- Your main scripts (scroll events, confetti, etc.) -->
  <script src="js/scripts.js"></script>

  <script type="text/javascript">
    var docContentEl = document.getElementById("docsContent");
    var tocListEl = document.getElementById("tocList");
    var headingObserver = null;

    var docsSidebar = document.getElementById("docsSidebar");
    var sidebarTab = document.getElementById("sidebarTab");
    var closeSidebarBtn = document.getElementById("closeSidebarBtn");

    document.addEventListener("DOMContentLoaded", function() {
      // 1) Attach click handlers to .doc-link
      var docLinks = document.querySelectorAll(".doc-link");
      docLinks.forEach(function(link) {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          // remove 'active' from all links
          docLinks.forEach(function(l) { l.classList.remove("active"); });
          // highlight the clicked link
          link.classList.add("active");

          // If mobile, close the sidebar after link is chosen
          if (window.innerWidth < 992) {
            docsSidebar.classList.remove("open");
            // show the tab again
            sidebarTab.style.display = "flex";
          }

          var fileName = link.getAttribute("data-doc");
          if (fileName) loadMarkdown(fileName);
        });
      });

      // 2) Auto-load welcome.md
      var welcomeLink = document.getElementById("welcomeLink");
      if (welcomeLink) {
        welcomeLink.classList.add("active");
        loadMarkdown("welcome.md");
      }

      // 3) Tab click => open sidebar (mobile), hide the tab
      sidebarTab.addEventListener("click", function() {
        docsSidebar.classList.add("open");
        // hide the tab
        sidebarTab.style.display = "none";
      });

      // 4) Close button => close sidebar (mobile), show the tab again
      closeSidebarBtn.addEventListener("click", function() {
        docsSidebar.classList.remove("open");
        sidebarTab.style.display = "flex";
      });
    });

    /* loadMarkdown */
    function loadMarkdown(fileName) {
      docContentEl.innerHTML =
        '<div class="text-center text-secondary my-5">' +
        '  <div class="spinner-border text-info mb-3" role="status"></div>' +
        '  <p>Loading <strong>' + fileName + '</strong>...</p>' +
        '</div>';

      tocListEl.innerHTML = '<li class="text-secondary" style="font-size: 0.85rem;">Generating Table of Contents...</li>';

      if (headingObserver) {
        headingObserver.disconnect();
        headingObserver = null;
      }

      fetch('docs/' + fileName)
        .then(function(resp) {
          if (!resp.ok) {
            throw new Error('File not found: ' + fileName);
          }
          return resp.text();
        })
        .then(function(md) {
          var html = marked.parse(md);
          docContentEl.innerHTML = html;
          buildTOC();
          attachTocLinksSmoothScroll();
          observeHeadingsForHighlight();
        })
        .catch(function(err) {
          docContentEl.innerHTML =
            '<div class="alert alert-danger">' +
            '  <strong>Error:</strong> ' + err.message +
            '</div>';
          tocListEl.innerHTML = '<li class="text-secondary">No TOC</li>';
        });
    }

    /* buildTOC */
    function buildTOC() {
      var headings = docContentEl.querySelectorAll("h2, h3, h4");
      if (!headings.length) {
        tocListEl.innerHTML = '<li class="text-secondary">No headings found.</li>';
        return;
      }
      tocListEl.innerHTML = "";

      headings.forEach(function(heading) {
        if (!heading.id) {
          heading.id = heading.textContent
            .toLowerCase()
            .replace(/[^\w]+/g, "-");
        }
        var level = parseInt(heading.tagName.substring(1), 10);
        var li = document.createElement("li");
        li.style.marginLeft = ((level - 2) * 1.5) + "rem";
        li.innerHTML =
          '<a href="#' + heading.id + '" class="toc-link">' +
          heading.textContent + '</a>';
        tocListEl.appendChild(li);
      });
    }

    /* attachTocLinksSmoothScroll */
    function attachTocLinksSmoothScroll() {
      var tocLinks = document.querySelectorAll(".toc-link");
      var docsMain = document.querySelector(".docs-main");
      tocLinks.forEach(function(link) {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          var targetId = link.getAttribute("href").substring(1);
          var targetEl = document.getElementById(targetId);
          if (targetEl) {
            var offsetTop = targetEl.offsetTop;
            docsMain.scrollTo({
              top: offsetTop - 10,
              behavior: 'smooth'
            });
          }
        });
      });
    }

    /* observeHeadingsForHighlight */
    function observeHeadingsForHighlight() {
      var docsMain = document.querySelector(".docs-main");
      var headings = docContentEl.querySelectorAll("h2, h3, h4");
      if (!headings.length) return;

      var headingRatios = new Map();
      headingObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          headingRatios.set(entry.target.id, entry.intersectionRatio);
        });
        // find heading with largest ratio
        var maxRatio = 0;
        var maxId = null;
        headingRatios.forEach(function(ratio, id) {
          if (ratio > maxRatio) {
            maxRatio = ratio;
            maxId = id;
          }
        });
        var allTocLinks = document.querySelectorAll(".toc-link");
        allTocLinks.forEach(function(link) {
          if (link.getAttribute("href") === "#" + maxId) {
            link.classList.add("toc-active");
          } else {
            link.classList.remove("toc-active");
          }
        });
      }, {
        root: docsMain,
        threshold: Array.from({ length: 101 }, function(_, i) { return i / 100; })
      });

      headings.forEach(function(h) {
        headingObserver.observe(h);
      });
    }

    /* filterDocLinks */
    function filterDocLinks() {
      var query = document.getElementById("docSearch").value.toLowerCase();
      var allLinks = document.querySelectorAll(".sidebar-link");
      allLinks.forEach(function(link) {
        var text = link.textContent.toLowerCase();
        link.style.display = (text.includes(query)) ? "" : "none";
      });
    }
  </script>
</body>
</html>
